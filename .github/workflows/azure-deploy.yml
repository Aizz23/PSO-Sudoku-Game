name: CI/CD Pipeline - Test, Build, Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AZURE_REGISTRY_LOGIN_SERVER: sudokustrupwa.azurecr.io
  AZURE_RESOURCE_GROUP: sudoku-rg
  BACKEND_IMAGE_NAME: sudoku-backend
  FRONTEND_IMAGE_NAME: sudoku-frontend
  NODE_VERSION: '20'
  
jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: TESTING (Quality Gate)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  test-backend:
    name: ğŸ§ª Test Backend
    runs-on: ubuntu-latest

    services:
      mongodb: 
        image: mongo:7
        ports:
          - 27017:27017
        options:  >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: package-lock.json
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Run tests
      run: npm test --workspace=backend
      env:
        MONGODB_URI_TEST: mongodb://localhost:27017/sudoku-test
        NODE_ENV: test
      
    - name: âœ… Backend tests passed
      run: echo "Backend tests completed successfully!"
  
  test-frontend:
    name: ğŸ§ª Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: package-lock.json
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Run tests
      run: npm test --workspace=frontend -- --coverage --watchAll=false
      
    - name: ğŸ—ï¸ Build check
      run: npm run build --workspace=frontend
      
    - name: âœ… Frontend tests passed
      run: echo "Frontend tests completed successfully!"
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: BUILD & PUSH (Only if tests pass)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  build-backend:
    name: ğŸ—ï¸ Build and Push Backend
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ” Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    
    - name: ğŸ—ï¸ Build and push Backend Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: |
          ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}
          ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:latest
        cache-from: type=gha,scope=backend
        cache-to: type=gha,mode=max,scope=backend
    
    - name: ğŸ” Scan Backend image for vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-backend-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: ğŸ“¤ Upload Backend scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-backend-results.sarif'
        category: 'backend-image'
    
    - name: ğŸ“ Backend Image Info
      run: |
        echo "âœ… Backend image pushed successfully!"
        echo "ğŸ“¦ Tags:"
        echo "  - ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}"
        echo "  - ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:latest"

  build-frontend:
    name: ğŸ—ï¸ Build and Push Frontend
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ” Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    
    - name: ğŸ—ï¸ Build and push Frontend Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: |
          ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}
          ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE_NAME }}:latest
        cache-from: type=gha,scope=frontend
        cache-to: type=gha,mode=max,scope=frontend
    
    - name: ğŸ” Scan Frontend image for vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-frontend-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: ğŸ“¤ Upload Frontend scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-frontend-results.sarif'
        category: 'frontend-image'
    
    - name: ğŸ“ Frontend Image Info
      run: |
        echo "âœ… Frontend image pushed successfully!"
        echo "ğŸ“¦ Tags:"
        echo "  - ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}"
        echo "  - ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE_NAME }}:latest"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: DEPLOYMENT TO AZURE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deploy-to-azure:
    name: ğŸš€ Deploy to Azure Container Apps
    needs: [build-backend, build-frontend]
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: ğŸš€ Deploy Backend
      run: |
        echo "ğŸ”„ Updating Backend Container App..."
        az containerapp update \
          --name sudoku-backend \
          --resource-group sudoku-rg \
          --image ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/sudoku-backend:latest
    
    - name: ğŸš€ Deploy Frontend
      run: |
        echo "ğŸ”„ Updating Frontend Container App..."
        az containerapp update \
          --name sudoku-frontend \
          --resource-group sudoku-rg \
          --image ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/sudoku-frontend:latest
    
    - name: âœ… Verify Deployment
      run: |
        echo "ğŸ” Checking Container App status..."
        az containerapp show \
          --name sudoku-frontend \
          --resource-group sudoku-rg \
          --query "properties.configuration.ingress.fqdn" -o tsv

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: DEPLOYMENT INFO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  deployment-instructions:
    name: ğŸš€ Deployment Summary
    needs: [build-backend, build-frontend, deploy-to-azure]
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“ Show Deployment Commands
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  ğŸ‰ CI/CD PIPELINE COMPLETED SUCCESSFULLY!            â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… Stage 1: Tests Passed"
        echo "âœ… Stage 2: Docker Images Built & Pushed to ACR"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš€ DEPLOYMENT COMMANDS:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "# Option 1: Deploy All (Backend + Frontend)"
        echo "./deploy-all.sh"
        echo ""
        echo "# Option 2: Deploy Individual Services"
        echo "./deploy-backend.sh"
        echo "./deploy-frontend.sh"
        echo ""
        echo "# Option 3: Manual Azure CLI"
        echo "az containerapp update \\"
        echo "  --name ${{ secrets.AZURE_CONTAINER_APP_BACKEND }} \\"
        echo "  --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \\"
        echo "  --image ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:latest"
        echo ""
        echo "az containerapp update \\"
        echo "  --name ${{ secrets.AZURE_CONTAINER_APP_FRONTEND }} \\"
        echo "  --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \\"
        echo "  --image ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE_NAME }}:latest"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ Images Available:"
        echo "  Backend:  ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE_NAME }}:latest"
        echo "  Frontend: ${{ env.AZURE_REGISTRY_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE_NAME }}:latest"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"